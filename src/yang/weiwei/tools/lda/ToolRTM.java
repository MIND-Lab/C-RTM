package yang.weiwei.tools.lda;

import java.io.IOException;

import yang.weiwei.lda.rtm.RTM;
import yang.weiwei.lda.LDAParam;

public class ToolRTM extends ToolLDA {
	protected double nu = 1.0;
	protected boolean directed = false;
	protected int PLRInterval = 20;
	protected boolean negEdge = false;
	protected double negEdgeRatio = 1.0;

	protected String rtmTrainGraphFileName = "";
	protected String rtmTestGraphFileName = "";
	protected String predFileName = "";
	protected String regFileName = "";
	
	protected String plrFileName = "";
	protected String hitsFileName = "";
	protected String ndcgFileName = "";

	protected String rtmTestEdgesFileName = "";

	public void parseCommand(String[] args) {
		super.parseCommand(args);

		nu = getArg("--nu", args, 1.0);
		directed = findArg("--directed", args, false);

		// PLRInterval = getArg("--plr-int", args, 20);

		negEdge = findArg("--neg", args, false);
		negEdgeRatio = getArg("--neg-ratio", args, 1.0);

		rtmTrainGraphFileName = getArg("--rtm-train-graph", args);
		rtmTestGraphFileName = getArg("--rtm-test-graph", args);

		rtmTestEdgesFileName = getArg("--rtm-test-edges", args);

		predFileName = getArg("--pred", args);
		regFileName = getArg("--reg", args);
		
		plrFileName = getArg("--plr", args);
		ndcgFileName = getArg("--ndcg", args);
		hitsFileName = getArg("--hits", args);

	}

	protected boolean checkCommand() {
		if (!super.checkCommand())
			return false;

		if (rtmTrainGraphFileName.length() == 0 && !test) {
			println("RTM train graph file is not specified.");
			return false;
		}

		if (!test && rtmTestGraphFileName.length() == 0) {
			rtmTestGraphFileName = rtmTrainGraphFileName;
		}

		if (rtmTestGraphFileName.length() == 0 && test) {
			println("RTM test graph is not specified.");
			return false;
		}

		if (nu <= 0.0) {
			println("Parameter nu must be a positive real number.");
			return false;
		}

		if (PLRInterval <= 0) {
			println("Interval of computing PLR must be a positive integer.");
			return false;
		}

		if (negEdge && negEdgeRatio < 0.0) {
			println("Negative edge ratio must be a non-negative real number.");
			return false;
		}

		return true;
	}

	protected LDAParam createParam() throws IOException {
		LDAParam param = super.createParam();
		param.nu = nu;
		param.directed = directed;
		param.showPLRInterval = PLRInterval;
		param.negEdge = negEdge;
		param.negEdgeRatio = negEdgeRatio;
		return param;
	}

	public void execute() throws IOException {
		/*
		 * if (!checkCommand()) { printHelp(); return; }
		 * 
		 */
		LDAParam param = createParam();
		RTM lda = null;
		if (!test) {
			lda = new RTM(param);
			lda.readCorpus(corpusFileName);
			lda.readGraph(rtmTrainGraphFileName, RTM.TRAIN_GRAPH);
			// lda.readGraph(rtmTestGraphFileName, RTM.TEST_GRAPH);
			if (param.constrained) {
				if (trainConstraintsFileName.length() > 0)
					lda.readDocConstraints(trainConstraintsFileName);
				if (trainVocabConstraintsFileName.length() > 0)
					lda.readVocabConstraints(trainVocabConstraintsFileName);

			}
			lda.initialize();
			if (burnin > 0)
				lda.sample(numIters, burnin);
			else
				lda.sample(numIters);
			lda.writeModel(modelFileName);
		} else {
			lda = new RTM(modelFileName, param);
			lda.readCorpus(corpusFileName);
			System.out.println("rtmTrainGraphFileName " + rtmTrainGraphFileName);
			System.out.println("rtmTestGraphFileName " + rtmTestGraphFileName);

			if (rtmTrainGraphFileName.length() > 0)
				lda.readGraph(rtmTrainGraphFileName, RTM.TRAIN_GRAPH);
			lda.readGraph(rtmTestGraphFileName, RTM.TEST_GRAPH);
			if (param.constrained) {
				if (trainConstraintsFileName.length() > 0)
					lda.readDocConstraints(trainConstraintsFileName);
				if (testConstraintsFileName.length() > 0)
					lda.readDocConstraints(testConstraintsFileName);

				if (testVocabConstraintsFileName.length() > 0)
					lda.readVocabConstraints(testVocabConstraintsFileName);

			}
			if (rtmTestEdgesFileName.length() > 0)
				lda.readEdgeLists(rtmTestEdgesFileName);

			lda.initialize();
			if (burnin > 0)
				lda.sample(numIters, burnin);
			else
				lda.sample(numIters);

			lda.writeModel(modelTestFileName);
		}
		writeFiles(lda);
	}

	protected void writeFiles(RTM lda) throws IOException {
		super.writeFiles(lda);

		if (predFileName.length() > 0)
			lda.writePred(predFileName);
		if (regFileName.length() > 0)
			lda.writeRegValues(regFileName);
		if (plrFileName.length() > 0)
			// lda.writePLR(plrFileName);
			lda.writePlrValues(plrFileName);
		if (hitsFileName.length() > 0)
			lda.writeHitsValues(hitsFileName);
		if (ndcgFileName.length() > 0)
			lda.writeNdcgValues(ndcgFileName);
	}

	public void printHelp() {
		super.printHelp();
		println("RTM arguments:");
		println("\t--rtm-train-graph [optional in test]: Link file for RTM to train.");
		println("\t--rtm-test-graph [optional in training]: Link file for RTM to evaluate. Can be the same with RTM train graph.");
		println("\t--nu [optional]: Variance of normal priors for weight vectors/matrices in RTM and its extensions (default: 1.0).");
		println("\t--plr-int [optional]: Interval of computing predictive link rank (default: 20).");
		println("\t--neg [optional]: Sample negative links (default: false).");
		println("\t--neg-ratio [optional]: The ratio of number of negative links to number of positive links (default 1.0).");
		println("\t--pred [optional]: Predicted document link probability matrix file.");
		println("\t--directed [optional]: Set all edges directed (default: false).");
	}
}
